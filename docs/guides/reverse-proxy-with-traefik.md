# Guide: Reverse Proxy with Traefik

This project uses Traefik as its reverse proxy, acting as the single entry point for all web services. It provides automatic HTTPS, service discovery, and centralized management of routing rules.

## Core Concepts

The Traefik setup is designed to be highly automated and easy to manage. It relies on a combination of static and dynamic configuration.

-   **Static Configuration (`traefik.yml`):** This file defines the server's core settings, which rarely change. This includes:
    -   **EntryPoints:** The ports Traefik listens on (e.g., `:80` for HTTP, `:443` for HTTPS).
    -   **Certificate Resolvers:** Configuration for automatically obtaining SSL certificates from Let's Encrypt using a Cloudflare DNS challenge.
    -   **Providers:** Instructions on where to find routing information (in our case, from the Docker socket and a dynamic configuration file).

-   **Dynamic Configuration (`dynamic_conf.yml`):** This file contains the actual routing rules for each service. It is dynamically generated by Ansible from a list of variables, and Traefik watches it for changes, applying new routing rules instantly without a restart.

-   **Tailscale Integration:** Traefik is not directly exposed to the public internet. Instead, it operates behind a Tailscale container, which handles secure ingress over the VPN. Traefik shares the network stack of the Tailscale container, ensuring all traffic is authenticated and encrypted by default.

## How to Expose a New Service

Exposing a new web service is a simple and centralized process. All you need to do is add an entry to the `traefik_services` list in the `config-ansible/roles/traefik/defaults/main.yml` file.

Each service entry is a YAML dictionary with the following keys:

-   `name`: A unique, lowercase name for the service (e.g., `myservice`).
-   `domain`: The full public domain where the service will be accessible (e.g., `myservice.your.domain`).
-   `url`: The internal URL of the backend service that Traefik should forward traffic to. This can be a container on the same host (e.g., `http://myservice-container:8000`) or an IP address on a different host (e.g., `http://192.168.1.100:8000`).
-   `basic_auth`: A boolean (`true` or `false`) that determines whether to apply basic authentication to the service.

### Example

To add a new service called "Heimdall" running on `debian003` at port `8090` and expose it at `heimdall.your.domain`, you would add the following to the `traefik_services` list:

```yaml
# in config-ansible/roles/traefik/defaults/main.yml

traefik_services:
  # ... other services
  - name: heimdall
    domain: heimdall.{{ hostname }}
    url: "http://{{ debian003_url }}:8090/"
    basic_auth: true # Protect this service with a password
```

After adding this entry and running the Ansible playbook, Traefik will automatically:
1.  Detect the new configuration.
2.  Create a new router for `heimdall.{{ hostname }}`.
3.  Obtain a valid SSL certificate for it from Let's Encrypt.
4.  Start proxying requests to the internal service at `http://192.168.1.50:8090/`.
5.  Enforce basic authentication because `basic_auth` was set to `true`.
