name: Infrastructure Dry Run

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  VAULT_ADDR: https://hashi-vault.aitbytes.fyi  # Adjust this to your Vault address

jobs:
  tofu-plan:
    name: OpenTofu Plan
    runs-on: ubuntu-latest
    container:
      image: hashicorp/terraform:1.6
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PUBLIC_KEY }}" | base64 -d > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

      - name: Configure Vault token
        run: |
          echo "VAULT_TOKEN=${{ secrets.VAULT_TOKEN }}" >> $GITHUB_ENV

      - name: OpenTofu Init and Plan
        working-directory: ./infra-terraform
        run: |
          terraform init
          terraform plan

  ansible-check:
    name: Ansible Check
    needs: tofu-plan
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/aitbytes/ansible:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PUBLIC_KEY }}" | base64 -d > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

      - name: Configure Vault token
        run: |
          echo "VAULT_TOKEN=${{ secrets.VAULT_TOKEN }}" >> $GITHUB_ENV

      - name: Ansible Dry Run
        working-directory: ./config-ansible
        run: |
          ansible-playbook site.yml --check --diff

